



function load_timesheet_report() {
	var data = colect_config_date();
	if (data) {
		var method_get_url = encodeURIComponent(JSON.stringify(data));
		location.href = REPORT + '?' + method_get_url;
	}
}

$(document).ready(function () {
	$('#load').click(function(event) {
		load_timesheet_report();
	});
	$('.remove-row').click(function(event) {
		var tr = $(this).closest('tr');
		tr.remove();
	});
	
	
	$('#send_mail').click(function(event) {
		var data = {}; 
		var rows = $('#report_timesheet').find('tr');
		var  week = null;
		rows.each(function() {
			var email, resource, work_hours, timeoff, total, detail, comment;
			if ($(this).hasClass('week')) {
				week = $(this).find('td:first-child').html();
			} else if ($(this).hasClass('report-content')) {
				var td = $(this).find('td');
				td.each(function() {
					if ($(this).hasClass('email')) {
						email = $(this).html();
					} else if ($(this).hasClass('resource')) {
						resource = $(this).html();
					} else if ($(this).hasClass('work-hours')) {
						work_hours = $(this).html();
					} else if ($(this).hasClass('timeoff')) {
						timeoff = $(this).html();
					} else if ($(this).hasClass('total')) {
						total = $(this).html();
					} else if ($(this).hasClass('detail')) {
						detail = $(this).html();
					} else if ($(this).hasClass('comment')) {
						comment = $(this).html();
					}
				})
				if (data[email] == undefined) {
					data[email] = {};
				}
				if (data[email][week] == undefined) {
					data[email][week] = [];
				}
				data[email][week].push([resource, work_hours, timeoff, total, detail, comment]);
			}
		});
		var popup_ctn = create_send_mail_popup(data);
		$('#overlay').html(popup_ctn);
		$('#overlay').show();

	});
	$(document).on('click', '.review-e-popup ul li span', function(){
		$('.mail-ctn').hide();
		var target_id = $(this).data("target");
		$(target_id).show();
	});
});

function create_send_mail_popup(data) {
	var popup_ctn = `<div class='review-e-popup'>
		<div class='review-e-title'>
			<span>Send Report</span>
		</div>
		<div  class='review-e-menu'>
			<ul>`
	var count = 0;
	var ctn = '';
	var template = get_template_content_asyn('components/sending_mail/report_timesheet.html');
	for (var [key, value] of Object.entries(data)) {
		count += 1;
				popup_ctn += '<li>';
				popup_ctn += "<input type='checkbox' data-target='#cnt_" + count + "'>";
				popup_ctn += "<span data-target='#cnt_" + count + "'>" + key + "</span>";	
				popup_ctn += '</li>';
				
				
				var week = 'ssss';
				var content = '';
				for (var [week, tb_info] of Object.entries(data[key])) {
					var row_info = data[key][week];
					content += 'Week: ' + week + '<br>';
					content += "<table class='e-rpt-tb'><thead>";
					content += "<tr><th>No.</th><th>Resource</th><th>Working hours</th><th>Off work</th>";
					content += "<th>Total</th><th>Detail</th><th>Comment</th></tr></thead>";
					content += "<tbody>";
					for (let idx = 0; idx < row_info.length; idx++) {
						var resource = row_info[idx][0];
						var w_hours = row_info[idx][1];
						var timeoff = row_info[idx][2];
						var total = row_info[idx][3];
						var detail = row_info[idx][4];
						var comment = row_info[idx][5];
						content += '<tr>';
						content += '<td>' + (idx + 1) + '</td>';
						content += '<td>' + resource + '</td>';
						content += '<td>' + w_hours + '</td>';
						content += '<td>' + timeoff + '</td>';
						content += '<td>' + total + '</td>';
						content += '<td>' + detail + '</td>';
						content += '<td>' + comment + '</td>';
						content += '</tr>';
					}
					
					content += "</tbody>";
					content += "</table>";
				}
				
				var mail_content = eval('`' + template + '`');
				
				
				
				var block = 'dp-none';
				if (count == 1) {
					block = 'dp-block';
				}
				ctn += "<div id='cnt_" + count + "' class='mail-ctn " + block + "' >" + mail_content + "</div>";
		}
	    popup_ctn += `</ul>
		</div>
		<div class='review-e-content'>`;
		popup_ctn += ctn;	
		popup_ctn += `</div>
		<div class='review-e-footer'>
			<button onclick='close_overlay();' id='' class='' data-toggle="tooltip" title="Cancel"><i class="fas fa-arrow-left"></i></button>
			<button onclick='' id='send' class='' data-toggle="tooltip" title="Save"><i class="fas fa-paper-plane"></i></button>
		</div>
	</div>`;
	return popup_ctn;
}



