from src.controllers.Controllers import Controllers
import os, sys

from src.commons.Utils import CommonUtils
import config
from datetime import timedelta
from flask import Flask, g, session, redirect, url_for
from src.controllers.routes.Route import timesheet_bp

from werkzeug.utils import secure_filename

ALLOWED_EXTENSIONS = {'xlsx', 'xls'}


port        = 6602
host        = "localhost"
tool_path = os.path.abspath(os.path.dirname(__file__))
# tool_path = '/var/www/html/wrs/app/'

app = Flask( __name__ , static_folder="%s/%s"%(tool_path, 'src/views/static'), template_folder="%s/%s"%(tool_path, 'src/views/templates'))
app.config['WORKING_PATH'] = config.WORKING_PATH
app.config['SECRET_KEY']                    = 'TEST'
app.config['SESSION_PERMANENT']             = True
app.config['PERMANENT_SESSION_LIFETIME']    = timedelta(days = 7)
app.register_blueprint(timesheet_bp)

argv = sys.argv[1:]
all_configs     = {}
# @app.before_request
# def global_var():
#     g.tool_path             = tool_path

def allowed_file(filename):
    return '.' in filename and \
           filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

@app.route('/', methods=['GET', 'POST'])
def upload_file():
    if request.method == 'POST':
        # check if the post request has the file part
        if 'file' not in request.files:
            flash('No file part')
            return redirect(request.url)
        file = request.files['file']
        # if user does not select file, browser also
        # submit an empty part without filename
        if file.filename == '':
            flash('No selected file')
            return redirect(request.url)
        if file and allowed_file(file.filename):
            filename = secure_filename(file.filename)
            file.save(os.path.join(app.config['WORKING_PATH'], filename))
            return redirect(url_for('uploaded_file',
                                    filename=filename))
    return '''
    <!doctype html>
    <title>Upload new File</title>
    <h1>Upload new File</h1>
    <form method=post enctype=multipart/form-data>
      <input type=file name=file>
      <input type=submit value=Upload>
    </form>
    '''
            
if __name__ == "__main__":
    app.run(port=port, host=host, debug=True, use_reloader=True, threaded=True)
    
    
    
    
